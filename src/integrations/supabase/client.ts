
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://vcywiyvbfrylffwfzsny.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeXdpeXZiZnJ5bGZmd2Z6c255Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0ODA3MDIsImV4cCI6MjA1MzA1NjcwMn0.rZUZjLf4j6h0lhl53PhKJ0eARsBXdmlPOtIAHTJQxNE";

// Simple client configuration with longer timeouts and better retry logic
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
  },
  global: {
    fetch: (url: RequestInfo | URL, options?: RequestInit) => {
      return fetch(url, options);
    },
  },
  realtime: {
    params: {
      eventsPerSecond: 10 // Increased from 5 to 10 for more responsive updates
    }
  }
});

// Testing Supabase connectivity
supabase.from('profiles').select('id').limit(1).then(({ data, error }) => {
  if (error) {
    console.error('Error connecting to Supabase:', error);
  } else {
    console.info('Supabase is connected. Sample data:', data);
  }
});

// Improved realtime activation with proper error handling
export const enableRealtimeForTables = () => {
  try {
    // Subscribe to all relevant tables for engagement data
    const channel = supabase.channel('public:realtime')
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'shoutouts' 
      }, (payload) => {
        console.log('Shoutout change detected:', payload);
        
        // If a new post is created, notify users with matching programming languages
        if (payload.eventType === 'INSERT' && payload.new) {
          const content = payload.new.content;
          const postId = payload.new.id;
          const userId = payload.new.user_id;
          
          console.log('New post created. Checking for programming languages to notify users.');
          console.log('Post content:', content);
          
          // Get the user's programming languages from their profile
          supabase
            .from('profiles')
            .select('programming_languages')
            .eq('user_id', userId)
            .single()
            .then(({ data: authorProfile, error: profileError }) => {
              if (profileError) {
                console.error('Error fetching author profile:', profileError);
                return;
              }
              
              console.log('Author profile languages:', authorProfile?.programming_languages);
              
              // Extract the author's programming languages
              let authorLanguages: string[] = [];
              if (authorProfile?.programming_languages) {
                if (Array.isArray(authorProfile.programming_languages)) {
                  authorLanguages = authorProfile.programming_languages.map(lang => 
                    typeof lang === 'string' ? lang.toLowerCase().trim() : ''
                  ).filter(Boolean);
                } else if (typeof authorProfile.programming_languages === 'string') {
                  try {
                    const parsed = JSON.parse(authorProfile.programming_languages);
                    authorLanguages = Array.isArray(parsed) ? 
                      parsed.map(lang => typeof lang === 'string' ? lang.toLowerCase().trim() : '').filter(Boolean) : 
                      [];
                  } catch (e) {
                    // If it's not valid JSON, treat it as a string
                    authorLanguages = [authorProfile.programming_languages.toLowerCase().trim()];
                  }
                }
              }
              
              if (authorLanguages.length > 0) {
                console.log('Author has programming languages:', authorLanguages);
                
                // Also extract languages from the content
                const contentLanguages = extractLanguageMentions(content);
                console.log('Languages extracted from content:', contentLanguages);
                
                // Combine languages from both sources and remove duplicates
                const allLanguages = [...new Set([...authorLanguages, ...contentLanguages])];
                console.log('Combined languages for notification:', allLanguages);
                
                // Notify users with matching programming languages via edge function
                supabase.functions.invoke('send-language-notifications', {
                  body: { 
                    postId,
                    languages: allLanguages,
                    content: content,
                    userId: userId,
                    immediate: true,
                    debug: true
                  }
                }).then(({ data, error }) => {
                  if (error) {
                    console.error('Error sending language notifications:', error);
                  } else {
                    console.log('Language notifications sent successfully:', data);
                  }
                });
              } else {
                console.log('Author has no programming languages set. Checking content for languages...');
                // Try to find languages in the content
                const contentLanguages = extractLanguageMentions(content);
                
                if (contentLanguages.length > 0) {
                  console.log('Languages found in content:', contentLanguages);
                  
                  // Notify users with matching programming languages
                  supabase.functions.invoke('send-language-notifications', {
                    body: { 
                      postId,
                      languages: contentLanguages,
                      content: content,
                      userId: userId,
                      immediate: true,
                      debug: true
                    }
                  }).then(({ data, error }) => {
                    if (error) {
                      console.error('Error sending language notifications:', error);
                    } else {
                      console.log('Language notifications sent successfully:', data);
                    }
                  });
                } else {
                  console.log('No programming languages found in author profile or content. No notifications will be sent.');
                }
              }
            });
        }
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'comments' 
      }, (payload) => {
        console.log('Comment change detected:', payload);
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'post_reactions' 
      }, (payload) => {
        console.log('Reaction change detected:', payload);
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'comment_reactions' 
      }, (payload) => {
        console.log('Comment reaction change detected:', payload);
      })
      .subscribe((status) => {
        console.log('Realtime subscription status:', status);
      });
      
    return channel;
  } catch (err) {
    console.error('Error setting up realtime:', err);
    return null;
  }
};

// Helper functions for array handling
export const prepareArrayField = (field: string[]): string => {
  return JSON.stringify(field);
};

export const parseArrayField = (field: string | null): string[] => {
  if (!field) return [];
  try {
    const parsed = JSON.parse(field);
    return Array.isArray(parsed) ? parsed : [field];
  } catch (error) {
    return [field];
  }
};

// Improved function to extract programming languages from post content
export const extractLanguageMentions = (content: string): string[] => {
  if (!content) return [];
  
  console.log('Scanning post content for programming languages');
  
  // List of common programming languages to check for
  const commonLanguages = [
    'javascript', 'typescript', 'python', 'java', 'c#', 'csharp', 'c++', 'cpp', 
    'php', 'go', 'ruby', 'swift', 'kotlin', 'rust', 'dart', 'scala', 'r', 
    'perl', 'haskell', 'lua', 'sql', 'pl/sql', 'html', 'css'
  ];
  
  const matches = new Set<string>();
  
  // Scan content for programming language mentions (case insensitive)
  commonLanguages.forEach(language => {
    // Fix: TypeScript was inferring a 'never' type here due to regex complexities
    // Make sure we're using string types explicitly
    const languagePattern = String(language).toLowerCase();
    const regex = new RegExp(`\\b${languagePattern}\\b`, 'i');
    
    if (regex.test(content.toLowerCase())) {
      console.log(`Found programming language: ${language}`);
      matches.add(language.toLowerCase().trim());
    }
  });
  
  const uniqueMatches = Array.from(matches);
  console.log('Programming languages found in content:', uniqueMatches);
  
  return uniqueMatches;
};

// Function to notify users who have the same programming languages
export const notifyUsersWithSameLanguages = async (
  senderId: string, 
  languages: string[], 
  postContent: string, 
  postId: string
): Promise<void> => {
  try {
    console.log(`Finding users who have selected these programming languages: ${languages.join(', ')}`);
    
    // Only proceed if languages were found in the post
    if (languages.length === 0) {
      console.log('No programming languages to notify about');
      return;
    }
    
    // Invoke edge function to handle email notifications
    const { data, error } = await supabase.functions.invoke('send-language-notifications', {
      body: { 
        postId,
        languages,
        content: postContent,
        userId: senderId,
        immediate: true,
        debug: true
      }
    });
    
    if (error) {
      console.error('Error invoking notification function:', error);
    } else {
      console.log('Email notifications initiated successfully:', data);
    }
  } catch (error) {
    console.error('Error in notifyUsersWithSameLanguages:', error);
  }
};
