
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://vcywiyvbfrylffwfzsny.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjeXdpeXZiZnJ5bGZmd2Z6c255Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0ODA3MDIsImV4cCI6MjA1MzA1NjcwMn0.rZUZjLf4j6h0lhl53PhKJ0eARsBXdmlPOtIAHTJQxNE";

// Simple client configuration with longer timeouts and better retry logic
export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
  },
  global: {
    fetch: (url: RequestInfo | URL, options?: RequestInit) => {
      return fetch(url, options);
    },
  },
  realtime: {
    params: {
      eventsPerSecond: 10 // Increased from 5 to 10 for more responsive updates
    }
  }
});

// Testing Supabase connectivity
supabase.from('profiles').select('id').limit(1).then(({ data, error }) => {
  if (error) {
    console.error('Error connecting to Supabase:', error);
  } else {
    console.info('Supabase is connected. Sample data:', data);
  }
});

// Improved realtime activation with proper error handling
export const enableRealtimeForTables = () => {
  try {
    // Subscribe to all relevant tables for engagement data
    const channel = supabase.channel('public:realtime')
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'shoutouts' 
      }, (payload) => {
        console.log('Shoutout change detected:', payload);
        
        // If a new post is created, check for language mentions
        if (payload.eventType === 'INSERT' && payload.new) {
          const content = payload.new.content;
          console.log('Checking for language mentions in new post:', content);
          
          const languages = extractLanguageMentions(content);
          
          if (languages.length > 0) {
            console.log('Languages mentioned in new post:', languages);
            notifyLanguageUsers(
              payload.new.user_id, 
              languages, 
              content, 
              payload.new.id
            );
          } else {
            console.log('No language mentions found in post');
          }
        }
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'comments' 
      }, (payload) => {
        console.log('Comment change detected:', payload);
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'post_reactions' 
      }, (payload) => {
        console.log('Reaction change detected:', payload);
      })
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table: 'comment_reactions' 
      }, (payload) => {
        console.log('Comment reaction change detected:', payload);
      })
      .subscribe((status) => {
        console.log('Realtime subscription status:', status);
      });
      
    return channel;
  } catch (err) {
    console.error('Error setting up realtime:', err);
    return null;
  }
};

// Helper functions for array handling
export const prepareArrayField = (field: string[]): string => {
  return JSON.stringify(field);
};

export const parseArrayField = (field: string | null): string[] => {
  if (!field) return [];
  try {
    const parsed = JSON.parse(field);
    return Array.isArray(parsed) ? parsed : [field];
  } catch (error) {
    return [field];
  }
};

// Completely revamped language mention extraction with better regex
export const extractLanguageMentions = (content: string): string[] => {
  if (!content) return [];
  
  console.log('Extracting language mentions from content:', content);
  
  // Enhanced regex to match @language mentions more accurately
  // This will capture both @LanguageName and plain LanguageName in the content
  const mentionRegex = /@(\w+)/g;
  const matches = new Set<string>();
  let match;
  
  while ((match = mentionRegex.exec(content)) !== null) {
    if (match[1]) {
      const language = match[1].toLowerCase().trim();
      console.log('Found language mention:', language);
      matches.add(language);
    }
  }
  
  // Also scan for direct language mentions without @ symbol
  // Common programming languages to check for even without @ symbol
  const commonLanguages = [
    'javascript', 'typescript', 'python', 'java', 'c#', 'csharp', 'c++', 'cpp', 
    'php', 'go', 'ruby', 'swift', 'kotlin', 'rust', 'dart', 'scala', 'r', 
    'perl', 'haskell', 'lua', 'sql', 'html', 'css'
  ];
  
  commonLanguages.forEach(language => {
    // Use word boundary to ensure we're matching whole words
    const regex = new RegExp(`\\b${language}\\b`, 'i');
    if (regex.test(content.toLowerCase())) {
      console.log('Found direct language mention:', language);
      matches.add(language.toLowerCase());
    }
  });
  
  const uniqueMatches = Array.from(matches);
  console.log('All extracted language mentions:', uniqueMatches);
  
  return uniqueMatches;
};

// Completely revamped notification system to ensure emails are sent properly
export const notifyLanguageUsers = async (
  senderId: string, 
  languages: string[], 
  postContent: string, 
  postId: string
): Promise<void> => {
  try {
    console.log(`Starting notification process for languages: ${languages.join(', ')} in post ${postId}`);
    
    // Directly invoke edge function for email notifications with enhanced debugging
    try {
      console.log('Invoking send-language-notifications function...');
      
      const { data, error } = await supabase.functions.invoke('send-language-notifications', {
        body: { 
          postId,
          languages, // Pass the detected languages explicitly 
          content: postContent, // Pass the content for context
          immediate: true, // Flag to indicate this should be processed immediately
          debug: true // Enable debug mode for more verbose logging
        }
      });
      
      if (error) {
        console.error('Error invoking send-language-notifications function:', error);
      } else {
        console.log('Email notifications triggered successfully:', data);
      }
    } catch (invokeError) {
      console.error('Exception invoking send-language-notifications:', invokeError);
    }
    
    // Separately prepare in-app notifications for immediate feedback
    for (const language of languages) {
      try {
        console.log(`Finding users interested in ${language}...`);
        
        // Find users with this language in their profile
        const { data: profilesWithLanguage, error: profilesError } = await supabase
          .from('profiles')
          .select('user_id, programming_languages, email, email_notifications_enabled')
          .not('user_id', 'eq', senderId); // Don't notify the author
        
        if (profilesError) {
          console.error(`Error fetching profiles for language ${language}:`, profilesError);
          continue;
        }
        
        console.log(`Found ${profilesWithLanguage?.length || 0} profiles to check for language match`);
        
        // Filter users who have the tagged language
        const usersToNotify = profilesWithLanguage?.filter(profile => {
          // Parse programming_languages properly, handling different storage formats
          let userLanguages: string[] = [];
          
          if (profile.programming_languages) {
            if (Array.isArray(profile.programming_languages)) {
              userLanguages = profile.programming_languages;
            } else if (typeof profile.programming_languages === 'string') {
              try {
                const parsed = JSON.parse(profile.programming_languages);
                userLanguages = Array.isArray(parsed) ? parsed : [profile.programming_languages as string];
              } catch (e) {
                userLanguages = [profile.programming_languages as string];
              }
            }
          }
          
          // Case insensitive check to match languages
          const hasLanguage = userLanguages.some(lang => 
            lang.toLowerCase() === language.toLowerCase()
          );
          
          console.log(`User ${profile.user_id} has languages: ${userLanguages.join(', ') || 'none'}`);
          console.log(`User ${profile.user_id} has ${language}? ${hasLanguage}`);
          
          return hasLanguage && profile.email_notifications_enabled === true;
        }) || [];
        
        console.log(`Found ${usersToNotify.length} users to notify about ${language}`);
        
        if (usersToNotify.length === 0) continue;
        
        // Prepare notifications for database insertion
        const notifications = usersToNotify.map(profile => ({
          type: 'language_mention',
          recipient_id: profile.user_id,
          sender_id: senderId,
          content: `mentioned ${language} in a post`,
          metadata: {
            language,
            post_id: postId,
            post_excerpt: postContent.substring(0, 100) + (postContent.length > 100 ? '...' : '')
          },
          is_read: false
        }));
        
        // Insert notifications into the database
        if (notifications.length > 0) {
          console.log(`Inserting ${notifications.length} notification records...`);
          
          const { error: notificationError } = await supabase
            .from('notifications')
            .insert(notifications);
            
          if (notificationError) {
            console.error('Error creating notifications:', notificationError);
          } else {
            console.log(`Successfully created ${notifications.length} notifications`);
          }
        }
        
        // Directly send emails for immediate delivery
        for (const user of usersToNotify) {
          try {
            console.log(`Sending direct email notification to user ${user.user_id}...`);
            
            // Direct email invocation for immediate delivery
            const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email-notification', {
              body: {
                userId: user.user_id,
                subject: `New post about ${language}`,
                body: `There's a new post discussing ${language} on iBlue. Check it out and join the conversation!`,
                postId: postId,
                priority: 'high',
                debug: true
              }
            });
            
            if (emailError) {
              console.error(`Error sending email to user ${user.user_id}:`, emailError);
            } else {
              console.log(`Email sent successfully to user ${user.user_id}:`, emailData);
            }
          } catch (emailSendError) {
            console.error(`Exception sending email to user ${user.user_id}:`, emailSendError);
          }
        }
      } catch (langError) {
        console.error(`Error processing notifications for language ${language}:`, langError);
      }
    }
  } catch (error) {
    console.error('Error in notifyLanguageUsers:', error);
  }
};
